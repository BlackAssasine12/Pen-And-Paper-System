<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Management</title>
</head>
<body>
    <input type="number" id="maininput" value="100">
    <div id="characterContainer"></div>
    <button id="saveButton">Save</button>
    <input type="file" id="fileInput">

    <script>
        document.getElementById('fileInput').addEventListener('change', function (event) {
            console.log('File input changed');
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    console.log('File read');
                    const data = JSON.parse(e.target.result);
                    generateCharacterAttributes(data);
                };
                reader.readAsText(file);
            }
        });

        function generateCharacterAttributes(data) {
            const characterContainer = document.getElementById('characterContainer');
            characterContainer.innerHTML = '';

            const character = data.charakter;

            const attributeFlexContainer = document.createElement('div');
            attributeFlexContainer.classList.add('attributeFlexContainer');

            const sections = [
                { title: 'Modifier', attributes: character.fähigkeiten[0].modifier[0], sectionId: 'modifier' },
                { title: 'Erfahrung', attributes: character.werte[0], sectionId: 'erfahrung' },
                { title: 'Sonderwerte', attributes: character.fähigkeiten[0].sonderwerte[0], sectionId: 'sonderwerte' },
                { title: 'Attribute', attributes: character.fähigkeiten[0].attribute[0], sectionId: 'attribute' },
                { title: 'Talente', attributes: character.fähigkeiten[0].talente[0], sectionId: 'talente' },
                { title: 'DSA Talente', attributes: character.fähigkeiten[0].dsaTalente[0], sectionId: 'dsaTalente' },
                { title: 'Kampf Basiswerte', attributes: character.fähigkeiten[0].KampfBasiswerte[0], sectionId: 'KampfBasiswerte' }
            ];

            sections.forEach(section => {
                const container = document.createElement('div');
                container.classList.add('FlexItemContainer');
                container.innerHTML = `<h6>${section.title}</h6>`;

                for (let key in section.attributes) {
                    const flexItem = document.createElement('div');
                    flexItem.classList.add('FlexItem');
                    flexItem.innerHTML = `
                        ${key.charAt(0).toUpperCase() + key.slice(1)}
                        <input class="attributeInput ${section.sectionId}" type="number" value="${section.attributes[key]}" id="${section.sectionId}_${key}">
                    `;
                    container.appendChild(flexItem);
                }
                attributeFlexContainer.appendChild(container);
            });

            characterContainer.appendChild(attributeFlexContainer);

            addInputChangeListeners();
        }

        function addInputChangeListeners() {
            console.log('Adding input change listeners');
            const mainInput = document.getElementById('erfahrung_Gesteigerte');
            const adjustments = {
                'modifier': 1,
                'attribute': 5,
                'talente': 13,
                'dsaTalente': 12
            };

            Object.keys(adjustments).forEach(klass => {
                document.querySelectorAll(`.${klass}`).forEach(input => {
                    input.setAttribute('data-initial', input.value);

                    input.addEventListener('input', function() {
                        const initialValue = parseInt(input.getAttribute('data-initial'));
                        const newValue = parseInt(input.value);
                        const diff = newValue - initialValue;

                        if (!isNaN(diff)) {
                            mainInput.value = parseInt(mainInput.value) - (diff * adjustments[klass]);
                            input.setAttribute('data-initial', newValue);
                        }
                    });
                });
            });
        }
    </script>
</body>
</html>
